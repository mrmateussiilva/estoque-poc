name: Deploy Estoque POC

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy na VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          debug: true
          script_stop: true
          script: |
            echo "1. Identificando Usuário e Diretório"
            whoami
            pwd
            
            echo "2. Verificando Docker e Permissões"
            docker version || echo "Erro: Docker não encontrado ou sem permissão"
            docker compose version || docker-compose version || echo "Erro: Compose não encontrado"
            
            echo "3. Acessando Projeto"
            cd /opt/apps/estoque-poc || (echo "Erro: Diretório /opt/apps/estoque-poc não existe" && exit 1)
            ls -la
            
            echo "4. Verificando arquivo .env"
            if [ -f .env ]; then
              echo "✓ Arquivo .env encontrado"
              echo "Variáveis definidas:"
              grep -E '^(DB_|DATABASE_URL|PORT)' .env || echo "Nenhuma variável DB_ encontrada"
            else
              echo "✗ ERRO: Arquivo .env NÃO EXISTE!"
              echo "O backend precisa do .env para conectar no banco de dados."
              exit 1
            fi
            
            echo "5. Sincronizando Git"
            git fetch --all
            git reset --hard origin/main
            
            echo "6. Reiniciando Containers"
            docker compose down || docker-compose down || true
            docker compose up -d --build --force-recreate || docker-compose up -d --build --force-recreate
            
            echo "7. Status Final"
            sleep 3
            docker ps -a
            docker logs sge-backend --tail 30 2>&1 || echo "Container sge-backend não encontrado"
