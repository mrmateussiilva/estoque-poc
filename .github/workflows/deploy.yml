name: Deploy Estoque POC

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy na VPS via SSH
        run: |
          # Salvar a chave SSH em arquivo temporário
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Configurar SSH para não pedir confirmação de host
          cat >> ~/.ssh/config <<EOF
          Host vps
            HostName ${{ secrets.VPS_HOST }}
            User ${{ secrets.VPS_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          EOF
          
          # Executar comandos na VPS
          ssh vps bash -s <<'ENDSSH'
            set -e
            set -x
            
            echo "========== DEPLOY INICIADO =========="
            whoami
            pwd
            
            echo "========== VERIFICANDO DOCKER =========="
            docker version
            docker compose version || docker-compose version
            
            echo "========== ACESSANDO PROJETO =========="
            cd /opt/apps/estoque-poc
            ls -la
            
            echo "========== VERIFICANDO .ENV =========="
            if [ -f .env ]; then
              echo "✓ Arquivo .env encontrado"
              grep -E '^(DB_|DATABASE_URL|PORT)' .env | head -3 || echo "Nenhuma var DB_ encontrada"
            else
              echo "✗ ERRO: .env não existe!"
              exit 1
            fi
            
            echo "========== ATUALIZANDO CODIGO =========="
            git fetch --all
            git reset --hard origin/main
            git log -1 --oneline
            
            echo "========== SUBINDO CONTAINER =========="
            docker compose down || docker-compose down || true
            docker compose up -d --build --force-recreate || docker-compose up -d --build --force-recreate
            
            echo "========== STATUS FINAL =========="
            sleep 5
            docker ps -a
            docker logs sge-backend --tail 50 2>&1 || echo "Container não encontrado"
            
            echo "========== DEPLOY CONCLUIDO =========="
          ENDSSH
          
          # Limpar chave SSH
          rm -f ~/.ssh/deploy_key
