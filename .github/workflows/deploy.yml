name: Deploy Estoque POC

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy na VPS
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          cat >> ~/.ssh/config <<EOF
          Host vps
            HostName ${{ secrets.VPS_HOST }}
            User ${{ secrets.VPS_USER }}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile=/dev/null
          EOF
          
          echo "========== VERIFICANDO AMBIENTE =========="
          ssh vps 'whoami && pwd && echo "Conexao OK"'
          
          echo ""
          echo "========== VERIFICANDO SCRIPT DE DEPLOY =========="
          ssh vps 'ls -lah /opt/apps/estoque-poc/deploy.sh'
          
          echo ""
          echo "========== INICIANDO DEPLOY NA VPS =========="
          ssh vps 'cd /opt/apps/estoque-poc && bash -x deploy.sh 2>&1 | tee deploy.log; echo "Exit code: $?"'
          
          echo ""
          echo "========== EXIBINDO LOG DO DEPLOY =========="
          ssh vps 'cat /opt/apps/estoque-poc/deploy.log || echo "ERRO: deploy.log nao foi criado"'
          
          rm -f ~/.ssh/deploy_key
